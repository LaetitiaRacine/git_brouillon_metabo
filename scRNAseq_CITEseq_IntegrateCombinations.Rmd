---
title: "scRNAseq_CITEseq_IntegrateCombinations"
author: "Laëtitia Racine"
date: "2022-09-26"
subtitle: "Dernière modification : `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: "show"
    toc: false
    theme: journal
---


```{r, Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, Dependencies, message=F, warning=F}

library(Seurat)
library(dplyr)
library(tidyr)
library(kableExtra)

```

```{r, Working directories and external script}

directory = "/home/rparmentier/Bureau/Git_Metabo_Analysis/"
directory_exp = paste0(directory, "exp/")
directory_data = paste0(directory, "data/scRNAseq/")
directory_bin = paste0(directory, "bin/")

# Create a unique folder for output corresponding to the date of the day
current_date = format(Sys.time(), "%Y%m%d")
dir.create(path = paste0(directory_exp,"scRNAseq_CITEseq_IntegrateCombinaisons/"))
dir.create(path = paste0(directory_exp,"scRNAseq_CITEseq_IntegrateCombinaisons/", current_date))
directory_output = paste0(directory_exp, "scRNAseq_CITEseq_IntegrateCombinaisons/", current_date, "/")

# Load external script with functions and constantes 
source(file = paste0(directory_bin, "functions_constantes.R"))

```


# Objectif du code 

Ce code **permet de** :  
- fusionner les objets Seurat pour obtenir un seul objet contenant tout le dataset  
- calculer les métriques QC (pourcentage d'ARN mitochondrial et ribosomal) pour l'objet Seurat global  
- enregistrer l'objet Seurat global  

Il s'est **inspiré** de :   
- https://satijalab.org/seurat/articles/multimodal_vignette.html  
- https://satijalab.org/seurat/articles/pbmc3k_tutorial.html   
- https://nbisweden.github.io/workshop-scRNAseq/labs/compiled/seurat/seurat_01_qc.html   
  
On obtient **en sortie** un objet Seurat par condition et un objet Seurat pour le dataset. Un objet Seurat sert de conteneurs qui regroupent à la fois les données (comme les matrices de counts) mais aussi les analyses (comme les PCA ou clustering) d'un même *single-cell dataset*. Il contient plusieurs *Assays* selon le type de données : ARN, Protéine (ADT), Normalisation... On retrouve la matrice de *counts* pour chaque assay indiquant les features (= gènes de la base de données GRCh38) en ligne et les cellules identifiées par leur barcode en colonnes. Les commandes principales pour manipuler un objet Seurat sont indiquées dans la vignette : https://satijalab.org/seurat/articles/essential_commands.html. 

*NB : Il serait possible d'appliquer un filtre sur le nombre d'UMI nécessaire par gène pour qu'il ne soit pas considéré comme du bruit de fond ou alors sur le nombre de cellules devant exprimer le gène pour qu'on le conserve mais on a décidé de ne pas le faire pour le moment. Cela évite d'enlever trop d'informations dès le début. Il sera toujours possible d'appliquer ce genre de filtre par la suite si on se rend compte que les données sont biaisées.*


https://www.biostars.org/p/9516696/



**Fusion des objets Seurat selon les combinaisons souhaitées**  
- combinaison 1 : CTRL CTRL2 DON 2DG AOA  
- combinaison 2 : CTRLaK DONaK 2DGaK AOAaK  
- combinaison 3 : DON DONaK  
- combinaison 4 : 2DG 2DGaK  
- combinaison 5 : AOA AOAaK  
- combinaison 6 : CTRL CTRLaK  
- combinaison 7 : CTRL VPA  
```{r merge}
# Regroupement des objets individuels
merge_allcond = merge(x = data_CTRL, 
                      y = list(data_DON, data_2DG, data_CTRLaK, data_DONaK, data_2DGaK, data_VPA),
                      project = "10XMetabo_RNAseq-CITEseq")
```



```{r}
# Extraction de la liste des gènes mitochondriaux et ribosomaux
mito_genes = rownames(merge_allcond)[grep("^MT-", rownames(merge_allcond))]
ribo_genes <- rownames(merge_allcond)[grep("^RP[SL]", rownames(merge_allcond))]
print(mito_genes)
print(ribo_genes)

# Calcul des pourcentages et ajout à l'objet Seurat
merge_allcond[["percent.mt"]] <- PercentageFeatureSet(merge_allcond, pattern = "^MT-")
merge_allcond[["percent.ribo"]] <- PercentageFeatureSet(merge_allcond, pattern = "^RP[SL]")
```

```{r}
saveRDS(merge_allcond, file = paste0(dir_output, "data_allcond.rds"))
```

```{r, Rsession}

# Clean working space and show package version
rm(list = ls())
sessionInfo()

```
